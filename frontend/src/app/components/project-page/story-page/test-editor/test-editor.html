<div class="test-editor">
  @if (hasTestFile()) {
    <p-card class="w-full mb-4"
            [ngClass]="{'test-passed': testStatus() === 'passed', 'test-failed': testStatus() === 'failed'}">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <i class="pi pi-file-code text-primary-500"></i>
          <h4 class="text-base font-semibold m-0">Generiertes Test-Skript</h4>
        </div>
        <div class="flex gap-2">
          <p-button
            label="Test ausführen"
            icon="pi pi-play"
            size="small"
            severity="success"
            [loading]="isRunningTest()"
            (onClick)="runTest()">
          </p-button>
          <p-button
            label="Testläufe"
            icon="pi pi-clock"
            size="small"
            severity="info"
            [loading]="isLoadingTestRuns()"
            (onClick)="openTestRunsDrawer()">
          </p-button>
          <p-button
            label="Skript anzeigen & bearbeiten"
            icon="pi pi-code"
            size="small"
            (onClick)="openCodeDialog()">
          </p-button>
        </div>
      </div>
      <div class="mt-3 text-sm text-gray-600">
        @if (testResult()) {
          <span class="font-semibold">Letzter Lauf:</span>
          <span class="ml-1">{{ testResult()?.executedAt | date:'short' }}</span>
          <div class="mt-1 text-gray-500">{{ testResult()?.description }}</div>
        } @else {
          <span class="text-gray-500">Für diesen Test liegen noch keine Ausführungen vor.</span>
        }
      </div>
    </p-card>
  }

  <div class="flex items-center justify-between mb-4">
    <h4 class="text-base font-semibold m-0">{{ test().name }}</h4>
    <div class="flex gap-2">
      <p-button
        label="Mit KI ausführen"
        icon="pi pi-microchip-ai"
        size="small"
        variant="outlined"
        severity="help"
        styleClass="rainbow-border"
        [loading]="isGenerating()"
        (onClick)="generateTest()"
      >
      </p-button>
      <p-button
        label="Neue Zeile"
        icon="pi pi-plus"
        size="small"
        (onClick)="addRow()">
      </p-button>
      <p-button
        label="Speichern"
        icon="pi pi-save"
        size="small"
        [loading]="isSaving()"
        (onClick)="saveTest()">
      </p-button>
      <p-button
        label="Löschen"
        icon="pi pi-trash"
        (onClick)="confirmDelete()"
        size="small"
        [disabled]="!isDeleting">
      </p-button>
    </div>
  </div>

  @if (test().description) {
    <p class="text-sm text-gray-600 mb-4">{{ test().description }}</p>
  }

  <p-card class="w-full mb-4 bg-(--surface-ground) border-primary-300">
    <div class="flex items-center gap-100">
      <div class="flex items-center gap-2">
        <i class="pi pi-info-circle text-primary-500"></i>
        <span class="font-semibold">Umgebung:</span>
      </div>
      <p-select
        appendTo="body"
        [options]="environments()"
        [(ngModel)]="selectedEnvironment"
        placeholder="Umgebung auswählen"
        [editable]="true"
        optionLabel="name"
        class="w-full md:w-56"
        [showClear]="true"
      />
    </div>
  </p-card>

  <p-table
    #dt
    [value]="testSteps()"
    [columns]="cols"
    [tableStyle]="{ 'min-width': '50rem' }"
  >

    <ng-template pTemplate="header" let-columns>
      <tr>
        <th style="width: 3rem"></th>
        <th *ngFor="let col of columns" style="width: 30%">
          {{ col.header }}
        </th>
        <th style="width: 5rem">Aktionen</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-rowData let-index="rowIndex">
      <tr [pReorderableRow]="index">
        <td>
          <span class="pi pi-bars" pReorderableRowHandle></span>
        </td>
        <td>
          <input
            type="text"
            pInputText
            [(ngModel)]="rowData.aktion"
            (ngModelChange)="onCellEdit()"
            class="w-full"
            placeholder="Aktion eingeben..."/>
        </td>
        <td>
          <input
            type="text"
            pInputText
            [(ngModel)]="rowData.daten"
            (ngModelChange)="onCellEdit()"
            class="w-full"
            placeholder="Daten eingeben..."/>
        </td>
        <td>
          <input
            type="text"
            pInputText
            [(ngModel)]="rowData.erwartetesResultat"
            (ngModelChange)="onCellEdit()"
            class="w-full"
            placeholder="Erwartetes Resultat eingeben..."/>
        </td>
        <td>
          <p-button
            icon="pi pi-trash"
            [rounded]="true"
            [text]="true"
            severity="danger"
            size="small"
            (onClick)="deleteRow(index)">
          </p-button>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="5" class="text-center py-4">
          <div class="flex flex-col items-center gap-2">
            <i class="pi pi-inbox text-3xl text-gray-400"></i>
            <p class="text-gray-500">Keine Testschritte vorhanden. Fügen Sie einen neuen Schritt hinzu.</p>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <p-drawer
    [(visible)]="showTestRunsDrawer"
    [position]="'right'"
    [modal]="true"
    [dismissible]="true"
    [style]="{width: '24rem'}"
    header="Testläufe">
    <div class="test-run-drawer p-4">
      @if (isLoadingTestRuns()) {
        <div class="flex items-center justify-center py-10">
          <i class="pi pi-spin pi-spinner text-3xl text-primary-500"></i>
        </div>
      } @else if (testRuns().length === 0) {
        <div class="flex flex-col items-center justify-center gap-3 py-10 text-center text-gray-500">
          <i class="pi pi-history text-3xl"></i>
          <span>Keine Testläufe vorhanden.</span>
        </div>
      } @else {
        <div class="flex flex-col gap-3">
          @for (run of testRuns(); track run.id) {
            <div class="test-run-card" [ngClass]="{
              'test-run-card--passed': run.status === testStatusEnum.PASSED,
              'test-run-card--failed': run.status === testStatusEnum.FAILED
            }">
              <div class="flex items-center justify-between">
                <span class="font-semibold">{{ run.status }}</span>
                <span class="text-xs text-gray-500">{{ run.executedAt | date:'short' }}</span>
              </div>
              <p class="mt-2 text-sm text-gray-600">{{ run.description }}</p>
            </div>
          }
        </div>
      }
    </div>
  </p-drawer>

  <p-dialog
    [(visible)]="showCodeDialog"
    [header]="'Test-Skript bearbeiten: ' + test().name"
    [focusTrap]="true"
    [modal]="true"
    [draggable]="false"
    [maximizable]="true"
    [style]="{width: '80vw', height: '80vh'}"
    [contentStyle]="{padding: '0', height: 'calc(80vh - 150px)'}">
    @if (isLoadingCode()) {
      <div class="flex items-center justify-center h-full">
        <i class="pi pi-spin pi-spinner text-4xl text-primary-500"></i>
      </div>
    } @else {
      <app-monaco-editor
        [code]="testCode()"
        [language]="'typescript'"
        (codeChange)="onCodeChange($event)">
      </app-monaco-editor>
    }
    <ng-template pTemplate="footer">
      <p-button
        label="Abbrechen"
        icon="pi pi-times"
        (onClick)="showCodeDialog.set(false)"
        [text]="true"
        [disabled]="isSavingCode()">
      </p-button>
      <p-button
        label="Speichern"
        icon="pi pi-check"
        (onClick)="saveTestCode()"
        [loading]="isSavingCode()">
      </p-button>
    </ng-template>
  </p-dialog>
</div>
